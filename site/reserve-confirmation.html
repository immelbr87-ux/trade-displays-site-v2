<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Reserve Confirmation — Trade Displays by Bargain Bond</title>
  <meta name="description" content="Reservation confirmation for a scheduled display removal." />
  <link rel="stylesheet" href="/app.css" />
</head>
<body>

  <div class="topbar">
    <div class="container topbar-inner">
      <a class="brand" href="/">
        <div class="logo">B</div>
        <div>TRADE DISPLAYS <small>by Bargain Bond</small></div>
      </a>

      <div class="navlinks" aria-label="Primary">
        <a href="/market">Browse displays</a>
        <a href="/for-showrooms">For showrooms</a>
        <a href="/brand-compliance">Brand compliance</a>
        <a href="/faq">FAQ</a>
        <a href="/pilot">Pilot</a>
      </div>

      <div class="navcta">
        <a class="btn btn-ghost" href="#signin">Sign In</a>
        <a class="btn btn-primary" href="#create">Create Account</a>
      </div>
    </div>
  </div>

  <div class="container pagewrap">
    <div class="page-hero">
      <div class="page-hero-inner">
        <div>
          <div class="kicker"><span class="dot"></span> Reservation • escrow hold • pickup verification</div>
          <h1>Reserved (pilot confirmation)</h1>
          <p class="lede" id="sub">
            Loading reservation details…
          </p>
        </div>

        <div class="page-hero-actions">
          <a class="btn btn-pill" id="detailsBtn" href="/market">View details</a>
          <a class="btn btn-pill btn-primary" href="/market">Browse more</a>
        </div>
      </div>
    </div>

    <div style="height:18px"></div>

    <div class="market-shell">
      <div>
        <div class="panel" aria-label="Confirmation">
          <h3 id="t">Reservation confirmation</h3>
          <div class="muted small" style="margin-top:6px;line-height:1.55;" id="meta">
            —
          </div>

          <div class="hr" style="margin:14px 0;"></div>

          <div class="callout">
            <strong>Escrow hold created (pilot)</strong>
            <div class="small muted">
              Funds are held until pickup confirmation. You’ll inspect at pickup. If the item materially differs from the listing’s disclosure,
              flag it on-site before acceptance.
            </div>
          </div>

          <div style="height:12px"></div>

          <div class="small" style="line-height:1.75;">
            <div><strong>Pickup window:</strong> <span id="win">—</span></div>
            <div><strong>Condition grade:</strong> <span id="grade">—</span></div>
            <div><strong>Reference code:</strong> <span id="code">—</span></div>
          </div>

          <div class="hr" style="margin:14px 0;"></div>

          <h3>What to bring</h3>
          <ul class="small muted2" style="line-height:1.6;margin-top:8px;">
            <li>Vehicle appropriate for the item size</li>
            <li>Basic tools for removal/transport protection (blankets, straps)</li>
            <li>Your confirmation code (shown above)</li>
          </ul>

          <div style="height:12px"></div>

          <div class="actions">
            <a class="btn btn-pill" href="/market">Back to browse</a>
            <a class="btn btn-primary btn-pill" id="detailsBtn2" href="/market">View listing</a>
          </div>

          <div class="subnote" style="margin-top:10px;">
            Pilot note: This page is a confirmation stub. Payments and SMS/email notifications can be enabled after the pilot proves workflow.
          </div>
        </div>
      </div>

      <aside class="panel" aria-label="Policy">
        <h3>Final sale policy</h3>
        <div class="small muted2" style="line-height:1.55;margin-top:6px;">
          All items are sold “as-is.” Buyer inspection occurs at pickup before acceptance.
          Once accepted at pickup, the sale is final and escrow is released.
        </div>

        <div class="hr" style="margin:14px 0;"></div>

        <h3>Need to coordinate pickup?</h3>
        <div class="small muted2" style="line-height:1.55;margin-top:6px;">
          In the pilot, scheduling and location details can be shared after reservation to reduce unnecessary exposure.
        </div>
      </aside>
    </div>

    <div class="footer">
      <div class="hr"></div>
      <div class="fine">
        Trade Displays is operated by Bargain Bond. We facilitate escrow and commitment for scheduled showroom display removals.
      </div>
      <div class="footer-nav" aria-label="Footer navigation">
        <a href="/">Home</a>
        <a href="/market">Browse displays</a>
        <a href="/for-showrooms">For showrooms</a>
        <a href="/brand-compliance">Brand compliance</a>
        <a href="/faq">FAQ</a>
        <a href="/pilot">Pilot</a>
      </div>
    </div>
  </div>

  <script>
    (async function () {
      const qs = new URLSearchParams(location.search);
      const id = qs.get("id");
      const sub = document.getElementById("sub");
      const detailsBtn = document.getElementById("detailsBtn");
      const detailsBtn2 = document.getElementById("detailsBtn2");

      if (!id) {
        sub.textContent = "Missing listing id. Return to Browse Displays.";
        return;
      }

      const detailsUrl = `/listing-details?id=${encodeURIComponent(id)}`;
      detailsBtn.setAttribute("href", detailsUrl);
      detailsBtn2.setAttribute("href", detailsUrl);

      // simple reference code (non-secure demo)
      const ref = "TD-" + id.slice(-6).toUpperCase();

      try {
        const r = await fetch(`/.netlify/functions/listDisplays?id=${encodeURIComponent(id)}`, { cache: "no-store" });
        const data = await r.json();
        if (!r.ok) throw new Error(data?.error || "Failed to load listing.");

        const x = data.listing || (Array.isArray(data.listings) ? data.listings[0] : null) || null;
        if (!x) throw new Error("Listing not found.");

        const title = x.title || "Display Listing";
        const price = formatPrice(x.price);
        const grade = String(x.condition_grade || "").trim() || "?";
        const pickupLine = pickupWindowDateLine(x.pickup_window_start, x.pickup_window_end);

        sub.textContent = `You reserved: ${title}${price ? " • " + price : ""}. This is a pilot confirmation (no payment captured).`;

        document.getElementById("meta").textContent = `Listing: ${title}${price ? " • " + price : ""}`;
        document.getElementById("win").textContent = pickupLine;
        document.getElementById("grade").textContent = `Grade ${grade}`;
        document.getElementById("code").textContent = ref;

      } catch (e) {
        console.error(e);
        sub.textContent = "Reservation created (pilot), but listing details could not be loaded. Use the View listing button.";
        document.getElementById("code").textContent = ref;
      }

      function formatPrice(v) {
        if (v == null || v === "") return "";
        const n = Number(v);
        if (!Number.isFinite(n)) return "";
        return `$${n.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
      }

      function pickupWindowDateLine(start, end) {
        const s = parseDate(start);
        const e = parseDate(end);
        if (!s || !e) return "Window: shown after reserve";
        return `${fmtShort(s)}–${fmtShort(e)}`;
      }

      function parseDate(v) {
        const d = new Date(v);
        return isNaN(d) ? null : d;
      }

      function fmtShort(d) {
        return d.toLocaleDateString(undefined, { month: "short", day: "numeric" });
      }
    })();
  </script>

</body>
</html>
