<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Listing details — Trade Displays</title>
  <meta name="description" content="View floor model listing details: specs, condition, pickup window, and acceptance at pickup." />
  <link rel="stylesheet" href="app.css" />
</head>
<body>
  <div id="bb-header"></div>

  <div class="container section">
    <div style="display:flex;align-items:center;justify-content:space-between;gap:14px;flex-wrap:wrap;">
      <div>
        <div class="kicker">LISTING DETAILS</div>
        <h1 class="h2" style="margin:8px 0 0;">Showroom floor model</h1>
        <p class="muted" style="margin:8px 0 0;">Specs-first. Condition disclosed. Pickup-only. Acceptance on-site.</p>
      </div>
      <div style="display:flex;gap:10px;flex-wrap:wrap;">
        <a class="btn btn-pill" href="/market">Back to market</a>
        <a id="reserveTop" class="btn btn-primary btn-pill" href="#">Reserve</a>
      </div>
    </div>

    <div class="panel" style="margin-top:16px; padding: 0; overflow:hidden;">
      <div class="two-col" style="display:grid; grid-template-columns: 1.2fr .8fr; gap: 0;">
        <div style="padding: 18px; border-right: 1px solid var(--line2);">
          <div class="square" id="heroImage" style="width:100%; aspect-ratio: 1/1; background: rgba(11,11,15,.04); border:1px solid var(--line2); border-radius: 16px; overflow:hidden; display:grid; place-items:center;">
            <div class="muted">Loading image…</div>
          </div>
          <div style="height:14px;"></div>
          <div id="photoStrip" style="display:flex; gap:10px; overflow:auto; padding-bottom:6px;"></div>
        </div>
        <div style="padding: 18px;">
          <div id="badges" style="display:flex; gap:8px; flex-wrap:wrap;"></div>
          <div style="height:10px;"></div>

          <div style="display:flex; align-items:flex-end; justify-content:space-between; gap:12px;">
            <div>
              <div class="muted2 small">Asking price</div>
              <div id="price" style="font-size: 28px; font-weight: 900; letter-spacing:-.4px;">—</div>
            </div>
            <div style="text-align:right;">
              <div class="muted2 small">Condition</div>
              <div id="grade" style="font-size: 18px; font-weight: 850;">—</div>
            </div>
          </div>

          <div class="hr" style="margin:18px 0;"></div>

          <div class="stack" style="display:grid; gap:10px;">
            <div>
              <div class="muted2 small">Pickup window</div>
              <div id="pickup" style="font-weight: 800;">—</div>
              <div class="small muted" style="margin-top:4px;">Buyer inspects on-site. If it matches the listing, buyer confirms acceptance at pickup.</div>
            </div>
            <div>
              <div class="muted2 small">Location</div>
              <div id="location" style="font-weight: 800;">—</div>
            </div>
            <div>
              <div class="muted2 small">Specs</div>
              <div id="specs" class="small" style="line-height:1.6;">—</div>
            </div>
            <div>
              <div class="muted2 small">Notes</div>
              <div id="notes" class="small" style="line-height:1.6;">—</div>
            </div>
          </div>

          <div style="height:14px;"></div>

          <a id="reserve" class="btn btn-primary btn-pill btn-full" href="#">Reserve this floor model</a>
          <div class="small muted" style="margin-top:10px;">
            By reserving, you acknowledge this is <strong>pickup-only</strong> and <strong>as-is</strong>, and acceptance occurs at pickup.
            See <a href="/terms">terms</a>.
          </div>

          <details style="margin-top:14px;" class="legal-accordion">
            <summary style="cursor:pointer; font-weight:850;">What counts as a mismatch?</summary>
            <div class="small muted" style="margin-top:10px; line-height:1.6;">
              A mismatch is limited to <strong>material differences</strong> from the listing (wrong model, missing major components that were represented as included, undisclosed structural damage, or a grade that’s materially worse than stated).
              Normal showroom handling marks consistent with the stated grade are not a mismatch.
            </div>
          </details>
        </div>
      </div>
    </div>
  </div>

  <div id="bb-footer"></div>
  <script src="shared/include.js"></script>

  <script>
  (async function(){
    const qs = new URLSearchParams(location.search);
    const id = qs.get('id') || '';
    const reserveUrl = '/reserve-confirmation?id=' + encodeURIComponent(id);
    document.getElementById('reserve').setAttribute('href', reserveUrl);
    document.getElementById('reserveTop').setAttribute('href', reserveUrl);

    const setBadges = (x)=>{
      const el = document.getElementById('badges');
      if(!el) return;
      const verified = !!(x.verified || x.is_verified || x.verification === 'Verified');
      const status = String(x.status || 'In Stock');
      const ready = !!(x.ready_for_transit || x.readyForTransit);
      el.innerHTML = [
        verified ? '<span class="pilltag verified">Verified</span>' : '',
        '<span class="pilltag instock">' + esc(status) + '</span>',
        '<span class="pilltag">Pickup only</span>',
        ready ? '<span class="pilltag ready">Ready for transit</span>' : ''
      ].filter(Boolean).join('');
    };

    try{
      const r = await fetch('/.netlify/functions/getDisplay?id=' + encodeURIComponent(id), { cache: 'no-store' });
      const data = await r.json().catch(()=>({}));
      if(r.ok && data && (data.item || data.listing || data.record || data)){
        const x = data.item || data.listing || data.record || data;
        render(x);
        return;
      }
      // fallback: try listDisplays and find by id
      const r2 = await fetch('/.netlify/functions/listDisplays?pageSize=50', { cache: 'no-store' });
      const data2 = await r2.json().catch(()=>({}));
      const arr = Array.isArray(data2.listings) ? data2.listings : (Array.isArray(data2.items) ? data2.items : []);
      const x = arr.find(a => String(a.id||a.recordId||a.airtableId||'') === String(id)) || null;
      if(x){ render(x); return; }
      render(sample());
    }catch(e){
      render(sample());
    }

    function esc(v){
      return String(v ?? '').replace(/[&<>\"]/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','\"':'&quot;'}[c]));
    }
    function money(v){
      const n = Number(String(v||'').replace(/[^0-9.]/g,''));
      if(!isFinite(n)) return esc(v||'');
      return '$' + n.toLocaleString(undefined,{maximumFractionDigits:0});
    }
    function pickupWindow(start,end){
      if(!start && !end) return 'Pickup window disclosed';
      const s = start ? new Date(start) : null;
      const e = end ? new Date(end) : null;
      const fmt = d => d.toLocaleDateString(undefined,{month:'short', day:'numeric'});
      if(s && e) return `Pickup ${fmt(s)}–${fmt(e)}`;
      return `Pickup ${fmt(s||e)}`;
    }

    function render(x){
      document.title = (x.title || x.name || 'Listing details') + ' — Trade Displays';
      document.querySelector('h1.h2').textContent = x.title || x.name || 'Showroom floor model';
      document.getElementById('price').textContent = money(x.price || x.list_price || x.ask || '');
      document.getElementById('grade').textContent = 'Grade ' + String((x.grade || x.condition_grade || '—')).toUpperCase();
      document.getElementById('pickup').textContent = pickupWindow(x.pickup_window_start, x.pickup_window_end);
      document.getElementById('location').textContent = x.location || x.city_state || x.city || 'Pickup location disclosed after reservation';

      const specs = x.specs || x.specifications || x.details || '';
      const notes = x.notes || x.description || '';
      document.getElementById('specs').innerHTML = specs ? esc(specs).replace(/\n/g,'<br>') : '<span class="muted">No additional specs provided.</span>';
      document.getElementById('notes').innerHTML = notes ? esc(notes).replace(/\n/g,'<br>') : '<span class="muted">No notes.</span>';

      setBadges(x);

      const images = normalizeImages(x);
      const hero = document.getElementById('heroImage');
      const strip = document.getElementById('photoStrip');

      if(images.length){
        hero.innerHTML = `<img alt="Listing photo" src="${images[0]}" style="width:100%;height:100%;object-fit:cover;" />`;
        strip.innerHTML = images.slice(0,10).map((u,i)=>{
          return `<button class="btn" style="padding:0;border-radius:12px;width:78px;height:78px;overflow:hidden;" aria-label="View photo ${i+1}">
            <img alt="" src="${u}" style="width:100%;height:100%;object-fit:cover;" />
          </button>`;
        }).join('');
        [...strip.querySelectorAll('button')].forEach((b,idx)=>{
          b.addEventListener('click', ()=>{
            hero.innerHTML = `<img alt="Listing photo" src="${images[idx]}" style="width:100%;height:100%;object-fit:cover;" />`;
          });
        });
      } else {
        hero.innerHTML = '<div class="muted">No photo provided.</div>';
        strip.innerHTML = '';
      }
    }

    function normalizeImages(x){
      const out = [];
      const add = (v)=>{
        if(!v) return;
        if(typeof v === 'string') out.push(v);
        else if(Array.isArray(v)) v.forEach(add);
        else if(typeof v === 'object'){
          if(v.url) out.push(v.url);
          if(v.thumbnails && v.thumbnails.large && v.thumbnails.large.url) out.push(v.thumbnails.large.url);
        }
      };
      add(x.image_url || x.image || x.thumbnail_url);
      add(x.images);
      add(x.photos);
      return [...new Set(out)].filter(Boolean);
    }

    function sample(){
      return {
        title: 'Kallista kitchen faucet (display model)',
        price: 1299,
        grade: 'A',
        verified: true,
        status: 'In Stock',
        ready_for_transit: true,
        pickup_window_start: new Date(Date.now() + 3*864e5).toISOString(),
        pickup_window_end: new Date(Date.now() + 10*864e5).toISOString(),
        location: 'Milwaukee, WI (pickup address shared after reservation)',
        specs: 'Finish: Polished Chrome\nMount: Deck\nIncludes: faucet body, handle(s), escutcheon (if shown)\nNotes: showroom-installed; minor handling marks consistent with Grade A',
        notes: 'Pickup-only. Buyer inspects on-site. Acceptance confirmed at pickup.',
        images: []
      };
    }
  })();
  </script>
</body>
</html>
