<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Listing Details ‚Äî Trade Displays by Bargain Bond</title>
  <meta name="description" content="Specs-first listing details with pickup window and condition disclosure." />
  <link rel="stylesheet" href="/app.css" />
</head>
<body>

  <div class="topbar">
    <div class="container topbar-inner">
      <a class="brand" href="/">
        <div class="logo">B</div>
        <div>TRADE DISPLAYS <small>by Bargain Bond</small></div>
      </a>

      <div class="navlinks" aria-label="Primary">
        <a href="/market">Browse displays</a>
        <a href="/for-showrooms">For showrooms</a>
        <a href="/brand-compliance">Brand compliance</a>
        <a href="/faq">FAQ</a>
        <a href="/pilot">Pilot</a>
      </div>

      <div class="navcta">
        <a class="btn btn-ghost" href="#signin">Sign In</a>
        <a class="btn btn-primary" href="#create">Create Account</a>
      </div>
    </div>
  </div>

  <div class="container pagewrap">
    <div class="page-hero">
      <div class="page-hero-inner">
        <div>
          <div class="kicker"><span class="dot"></span> Listing details ‚Ä¢ specs-first ‚Ä¢ pickup window upfront</div>
          <h1 id="hTitle">Listing details</h1>
          <p class="lede" id="hSub">
            Loading‚Ä¶
          </p>
        </div>

        <div class="page-hero-actions">
          <a class="btn btn-pill" href="/market">Back to browse</a>
          <a class="btn btn-pill btn-primary" id="reserveTop" href="#">Reserve</a>
        </div>
      </div>
    </div>

    <div style="height:18px"></div>

    <div class="market-shell">
      <!-- LEFT -->
      <div>
        <div class="listing" style="margin-bottom:16px;">
          <div class="thumb" id="thumb" style="background-image:linear-gradient(180deg, rgba(11,18,32,.15), rgba(11,18,32,.35))">
            <div class="thumb-badges">
              <span class="pilltag ok" id="badgeGrade">Grade ‚Äî</span>
              <span class="pilltag soft" id="badgePickup">Pickup window set</span>
            </div>
          </div>

          <div class="listing-body">
            <div class="title">
              <h3 id="title">Loading‚Ä¶</h3>
              <div class="price" id="price"></div>
            </div>

            <div class="meta">
              <div id="mFinish">üè∑Ô∏è ‚Äî</div>
              <div id="mLocal">üìç Local pickup</div>
              <div id="mWindow">üóìÔ∏è ‚Äî</div>
              <div id="mDims">üìè ‚Äî</div>
            </div>

            <div class="divider"></div>

            <div class="actions">
              <a class="btn btn-primary btn-pill" id="reserveBtn" href="#">Reserve</a>
              <a class="btn btn-pill" href="/market">Continue browsing</a>
            </div>

            <div class="subnote" id="subnote">
              Funds held until pickup confirmation. Final sale. Condition verified at pickup.
            </div>
          </div>
        </div>

        <!-- DETAILS PANEL -->
        <div class="panel" aria-label="Details">
          <h3>Specs & disclosure</h3>
          <div class="muted small" style="margin-top:6px;line-height:1.55;">
            Listings are specs-first to reduce brand exposure during the pilot.
          </div>

          <div style="height:12px"></div>

          <div class="small" style="line-height:1.7;">
            <div><strong>Category:</strong> <span id="dCategory">‚Äî</span></div>
            <div><strong>Finish family:</strong> <span id="dFinish">‚Äî</span></div>
            <div><strong>Dimensions:</strong> <span id="dDims">‚Äî</span></div>
            <div><strong>Rough-in / key spec:</strong> <span id="dKeySpec">‚Äî</span></div>
            <div><strong>What‚Äôs included:</strong> <span id="dIncluded">‚Äî</span></div>
          </div>

          <div class="hr" style="margin:14px 0;"></div>

          <h3>Condition grade</h3>
          <div class="small muted2" id="gradeLegal" style="line-height:1.55;">
            ‚Äî
          </div>

          <div class="hr" style="margin:14px 0;"></div>

          <h3>Pickup & escrow</h3>
          <div class="small muted2" style="line-height:1.55;">
            Reservation places funds in escrow until pickup confirmation. At pickup, buyer inspects and either confirms acceptance
            or flags a material mismatch against the listing‚Äôs condition disclosure. All sales are final once accepted at pickup.
          </div>
        </div>
      </div>

      <!-- RIGHT -->
      <aside class="panel" aria-label="Reserve panel">
        <h3>Reserve this display</h3>
        <div class="muted small" style="margin-top:6px;line-height:1.55;">
          This pilot uses fixed pricing, local pickup, and no returns to keep removals clean and predictable.
        </div>

        <div class="callout" style="margin-top:14px;">
          <strong>What happens next</strong>
          <div class="small muted">
            You‚Äôll receive pickup instructions and a confirmation code. Showroom staff verifies condition at pickup.
          </div>
        </div>

        <div style="height:10px"></div>

        <a class="btn btn-primary btn-full btn-pill" id="reserveSide" href="#">Reserve (escrow hold)</a>

        <div class="chiprow" style="margin-top:12px;">
          <span class="chip">Fixed price</span>
          <span class="chip">Local pickup</span>
          <span class="chip">Final sale</span>
          <span class="chip">Escrow until pickup</span>
        </div>
      </aside>
    </div>

    <div class="footer">
      <div class="hr"></div>
      <div class="fine">
        Trade Displays is operated by Bargain Bond. We facilitate escrow and commitment for scheduled showroom display removals.
      </div>
      <div class="footer-nav" aria-label="Footer navigation">
        <a href="/">Home</a>
        <a href="/market">Browse displays</a>
        <a href="/for-showrooms">For showrooms</a>
        <a href="/brand-compliance">Brand compliance</a>
        <a href="/faq">FAQ</a>
        <a href="/pilot">Pilot</a>
      </div>
    </div>
  </div>

  <script>
    (async function () {
      const qs = new URLSearchParams(location.search);
      const id = qs.get("id");

      const hTitle = document.getElementById("hTitle");
      const hSub = document.getElementById("hSub");

      if (!id) {
        hTitle.textContent = "Listing details";
        hSub.textContent = "Missing listing id.";
        return;
      }

      try {
        const r = await fetch(`/.netlify/functions/listDisplays?id=${encodeURIComponent(id)}`, { cache: "no-store" });
        const data = await r.json();
        if (!r.ok) throw new Error(data?.error || "Failed to load listing.");

        // support either {listing:{}} or {listings:[one]}
        const x = data.listing || (Array.isArray(data.listings) ? data.listings[0] : null) || null;
        if (!x) throw new Error("Listing not found.");

        const title = x.title || "Display Listing";
        const price = formatPrice(x.price);
        const grade = String(x.condition_grade || "").trim() || "?";
        const pickupText = pickupWindowText(x.pickup_window_start, x.pickup_window_end);
        const pickupLine = pickupWindowDateLine(x.pickup_window_start, x.pickup_window_end);

        // hero
        hTitle.textContent = title;
        hSub.textContent = "Specs-first listing with pickup window and condition disclosure.";

        // buttons
        const reserveUrl = `/reserve-confirmation?id=${encodeURIComponent(id)}`;
        ["reserveTop","reserveBtn","reserveSide"].forEach(k => {
          const el = document.getElementById(k);
          if (el) el.setAttribute("href", reserveUrl);
        });

        // image
        const thumb = safeAttr(x.thumbnail_url || "");
        const thumbStyle = thumb
          ? `background-image:url('${thumb}')`
          : `background-image:linear-gradient(180deg, rgba(11,18,32,.15), rgba(11,18,32,.35))`;
        document.getElementById("thumb").setAttribute("style", thumbStyle);

        // badges
        document.getElementById("badgeGrade").textContent = `Grade ${grade}`;
        document.getElementById("badgePickup").textContent = pickupText;

        // main card
        document.getElementById("title").textContent = title;
        document.getElementById("price").textContent = price;

        const finish = x.finish_family || x.finish || x.color || "Specs-first listing";
        document.getElementById("mFinish").textContent = `üè∑Ô∏è ${finish}`;
        document.getElementById("mWindow").textContent = `üóìÔ∏è ${pickupLine}`;
        document.getElementById("mDims").textContent = `üìè ${x.dimensions || x.size || x.key_spec || "Specs disclosed"}`;

        // details
        document.getElementById("dCategory").textContent = x.category || "‚Äî";
        document.getElementById("dFinish").textContent = finish || "‚Äî";
        document.getElementById("dDims").textContent = x.dimensions || "‚Äî";
        document.getElementById("dKeySpec").textContent = x.key_spec || x.rough_in || "‚Äî";
        document.getElementById("dIncluded").textContent = x.whats_included || x.included || "‚Äî";

        // grade legal
        document.getElementById("gradeLegal").innerHTML = gradeLegalHtml(grade);

      } catch (e) {
        console.error(e);
        hTitle.textContent = "Listing details";
        hSub.textContent = "Could not load this listing. Try returning to Browse Displays.";
      }

      function formatPrice(v) {
        if (v == null || v === "") return "";
        const n = Number(v);
        if (!Number.isFinite(n)) return "";
        return `$${n.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
      }

      function pickupWindowText(start, end) {
        const s = parseDate(start);
        const e = parseDate(end);
        if (!s || !e) return "Pickup window set";
        const now = new Date();
        const d1 = Math.max(0, Math.round((s - now) / 86400000));
        const d2 = Math.max(0, Math.round((e - now) / 86400000));
        const a = Math.min(d1, d2);
        const b = Math.max(d1, d2);
        if (a === b) return `Pickup in ~${a} days`;
        return `Pickup in ${a}‚Äì${b} days`;
      }

      function pickupWindowDateLine(start, end) {
        const s = parseDate(start);
        const e = parseDate(end);
        if (!s || !e) return "Window: shown after reserve";
        return `Window: ${fmtShort(s)}‚Äì${fmtShort(e)}`;
      }

      function parseDate(v) {
        const d = new Date(v);
        return isNaN(d) ? null : d;
      }

      function fmtShort(d) {
        return d.toLocaleDateString(undefined, { month: "short", day: "numeric" });
      }

      function safeAttr(str) {
        return String(str || "").replaceAll("'", "%27").replaceAll('"', "%22");
      }

      function gradeLegalHtml(grade) {
        const g = String(grade || "").toUpperCase().trim();
        // contract-safe: no promises, no "like new", define scope
        if (g === "A") {
          return `
            <strong>Grade A (Installed Display ‚Äî Minimal Cosmetic Wear)</strong><br/>
            Installed showroom display expected to show <em>minimal</em> signs of prior handling or installation.
            Cosmetic imperfections may exist. Any accessories, trim, or mounting parts are included only if listed under ‚ÄúWhat‚Äôs included.‚Äù
            Buyer accepts ‚Äúas-is‚Äù at pickup after inspection.
          `;
        }
        if (g === "B") {
          return `
            <strong>Grade B (Installed Display ‚Äî Noticeable Cosmetic Wear)</strong><br/>
            Installed showroom display expected to show <em>noticeable</em> cosmetic wear consistent with showroom use/handling.
            Cosmetic imperfections may include scratches, scuffs, finish variation, or minor chips. Functionality is not guaranteed unless explicitly stated.
            Buyer accepts ‚Äúas-is‚Äù at pickup after inspection.
          `;
        }
        return `
          <strong>Condition grade</strong><br/>
          Condition is disclosed for transparency. Buyer accepts ‚Äúas-is‚Äù at pickup after inspection.
        `;
      }
    })();
  </script>

</body>
</html>
