<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Listing Details ‚Äî Trade Displays by Bargain Bond</title>
  <meta name="description" content="View details for a scheduled showroom display removal. Trade-only. Fixed price. Local pickup. Escrow until pickup confirmation." />
  <link rel="stylesheet" href="/app.css" />
</head>
<body>

  <div class="topbar">
    <div class="container topbar-inner">
      <a class="brand" href="/">
        <div class="logo">B</div>
        <div>TRADE DISPLAYS <small>by Bargain Bond</small></div>
      </a>

      <div class="navlinks" aria-label="Primary">
        <a href="/market">Browse displays</a>
        <a href="/for-showrooms">For showrooms</a>
        <a href="/brand-compliance">Brand compliance</a>
        <a href="/faq">FAQ</a>
        <a href="/pilot">Pilot</a>
      </div>

      <div class="navcta">
        <a class="btn btn-ghost" href="#signin">Sign In</a>
        <a class="btn btn-primary" href="#create">Create Account</a>
      </div>
    </div>
  </div>

  <div class="container pagewrap">
    <div class="page-hero">
      <div class="page-hero-inner">
        <div>
          <div class="kicker"><span class="dot"></span> Listing details ‚Ä¢ specs-first ‚Ä¢ pickup window upfront</div>
          <h1 id="h1">Loading‚Ä¶</h1>
          <p class="lede" id="lede">Pulling listing details from the pilot view.</p>
        </div>

        <div class="page-hero-actions">
          <a class="btn btn-pill" href="/market">Back to browse</a>
          <a class="btn btn-pill btn-primary" id="reserveBtn" href="#">Reserve</a>
        </div>
      </div>
    </div>

    <div style="height:18px"></div>

    <div class="market-shell">
      <!-- LEFT -->
      <div>
        <div class="panel" style="padding:0; overflow:hidden;">
          <div id="heroImage" class="thumb" style="height:260px; background-image:linear-gradient(180deg, rgba(11,18,32,.15), rgba(11,18,32,.35))">
            <div class="thumb-badges">
              <span class="pilltag ok" id="gradeTag">Grade ?</span>
              <span class="pilltag soft" id="pickupTag">Pickup window set</span>
            </div>
          </div>

          <div style="padding:18px;">
            <div class="title">
              <h3 id="title">‚Äî</h3>
              <div class="price" id="price"></div>
            </div>

            <div class="meta" style="margin-top:12px;">
              <div>üìç <span id="location">Local pickup</span></div>
              <div>üóìÔ∏è <span id="window">Window shown</span></div>
              <div>üìè <span id="dimensions">‚Äî</span></div>
              <div>üßæ <span id="specsFirst">Specs-first listing</span></div>
            </div>

            <div class="divider"></div>

            <h3 style="margin-top:0;">What‚Äôs included</h3>
            <ul id="includedList" class="bullets" style="margin-top:8px;">
              <li>Loading‚Ä¶</li>
            </ul>

            <div style="height:12px"></div>

            <div class="callout">
              <strong>Condition is confirmed at pickup</strong>
              <div class="small muted">
                Listing grade is a <em>listing standard</em> used for buyer expectation and dispute handling.
                Final condition is verified at pickup before funds are released.
              </div>
            </div>

            <div style="height:14px"></div>

            <div class="actions">
              <a class="btn btn-primary btn-pill" id="reserveBtn2" href="#">Reserve</a>
              <a class="btn btn-pill" href="/faq">How it works</a>
            </div>

            <div class="subnote" id="subnote">
              Funds held until pickup confirmation. Inspect at pickup. Final sale.
            </div>
          </div>
        </div>
      </div>

      <!-- RIGHT -->
      <aside class="panel">
        <h3>Listing snapshot</h3>

        <div class="grid3" style="margin-top:12px;">
          <div class="kv">
            <div class="k">Category</div>
            <div class="v" id="category">‚Äî</div>
          </div>
          <div class="kv">
            <div class="k">Finish family</div>
            <div class="v" id="finish">‚Äî</div>
          </div>
          <div class="kv">
            <div class="k">Key spec</div>
            <div class="v" id="keySpec">‚Äî</div>
          </div>
        </div>

        <div style="height:14px"></div>

        <div class="callout">
          <strong>Trade-only purchase</strong>
          <div class="small muted">
            This pilot is limited to trade professionals. No public discounting, no consumer traffic.
          </div>
        </div>

        <div class="chiprow" style="margin-top:12px;">
          <span class="chip">Fixed price</span>
          <span class="chip">Local pickup</span>
          <span class="chip">Final sale</span>
          <span class="chip">Escrow until pickup</span>
        </div>

        <div class="small muted2" style="margin-top:12px; line-height:1.55;">
          Ready to reserve? You‚Äôll confirm pickup window and receive a reservation summary.
        </div>

        <div style="height:10px"></div>

        <a class="btn btn-dark btn-full btn-pill" id="reserveBtn3" href="#">Reserve this listing</a>
      </aside>
    </div>

    <div class="footer">
      <div class="hr"></div>
      <div class="fine">
        Trade Displays is operated by Bargain Bond. We facilitate escrow and commitment for scheduled showroom display removals.
      </div>
      <div class="footer-nav" aria-label="Footer navigation">
        <a href="/">Home</a>
        <a href="/market">Browse displays</a>
        <a href="/for-showrooms">For showrooms</a>
        <a href="/brand-compliance">Brand compliance</a>
        <a href="/faq">FAQ</a>
        <a href="/pilot">Pilot</a>
      </div>
    </div>
  </div>

  <script>
    (async function () {
      const params = new URLSearchParams(location.search);
      const id = params.get("id");

      const h1 = document.getElementById("h1");
      const lede = document.getElementById("lede");

      const reserveHref = id ? `/reserve-confirmation?id=${encodeURIComponent(id)}` : "/market";
      ["reserveBtn", "reserveBtn2", "reserveBtn3"].forEach(k => {
        const el = document.getElementById(k);
        if (el) el.href = reserveHref;
      });

      if (!id) {
        h1.textContent = "Missing listing id";
        lede.textContent = "Return to Browse displays and open a listing from there.";
        return;
      }

      try {
        const r = await fetch(`/.netlify/functions/listings?id=${encodeURIComponent(id)}`, { cache: "no-store" });
        const data = await r.json();
        if (!r.ok) throw new Error(data?.error || "Failed to load listing.");

        const x = data.listing || {};
        const title = x.title || "Display Listing";
        const price = (x.price != null && x.price !== "") ? `$${Number(x.price).toLocaleString()}` : "";
        const grade = x.condition_grade || "?";
        const pickupTag = pickupWindowText(x.pickup_window_start, x.pickup_window_end);
        const windowLine = pickupWindowDateLine(x.pickup_window_start, x.pickup_window_end);

        h1.textContent = title;
        lede.textContent = "Specs-first listing. Condition is confirmed at pickup before funds are released.";

        document.getElementById("title").textContent = title;
        document.getElementById("price").textContent = price;

        document.getElementById("gradeTag").textContent = `Grade ${grade}`;
        document.getElementById("pickupTag").textContent = pickupTag;

        document.getElementById("location").textContent = x.location_text || "Local pickup";
        document.getElementById("window").textContent = windowLine;
        document.getElementById("dimensions").textContent = x.dimensions || "See key spec";
        document.getElementById("category").textContent = x.category || "‚Äî";
        document.getElementById("finish").textContent = x.finish_family || "‚Äî";
        document.getElementById("keySpec").textContent = x.key_spec || "‚Äî";

        // Image
        const hero = document.getElementById("heroImage");
        if (hero && x.thumbnail_url) {
          hero.style.backgroundImage = `url('${safeAttr(x.thumbnail_url)}')`;
          hero.style.backgroundSize = "cover";
          hero.style.backgroundPosition = "center";
        }

        // Included list
        const included = normalizeIncluded(x.whats_included);
        const ul = document.getElementById("includedList");
        ul.innerHTML = included.length
          ? included.map(item => `<li>${escapeHtml(item)}</li>`).join("")
          : `<li>Included items are confirmed at pickup.</li>`;

        // Subnote
        document.getElementById("subnote").textContent =
          "Funds held until pickup confirmation. Inspect at pickup. If the item materially differs from listing, reservation can be cancelled before release.";

      } catch (err) {
        console.error(err);
        h1.textContent = "Could not load listing";
        lede.textContent = "Check the record id and your Public_Active view filters.";
      }

      function normalizeIncluded(v) {
        if (!v) return [];
        if (Array.isArray(v)) return v.filter(Boolean).map(String);
        return String(v).split(/\n|‚Ä¢|,/).map(s => s.trim()).filter(Boolean);
      }

      function pickupWindowText(start, end) {
        const s = parseDate(start), e = parseDate(end);
        if (!s || !e) return "Pickup window set";
        const now = new Date();
        const d1 = Math.max(0, Math.round((s - now) / 86400000));
        const d2 = Math.max(0, Math.round((e - now) / 86400000));
        const a = Math.min(d1, d2), b = Math.max(d1, d2);
        return (a === b) ? `Pickup in ~${a} days` : `Pickup in ${a}‚Äì${b} days`;
      }

      function pickupWindowDateLine(start, end) {
        const s = parseDate(start), e = parseDate(end);
        if (!s || !e) return "Window: shown after reserve";
        return `Window: ${fmtShort(s)}‚Äì${fmtShort(e)}`;
      }

      function parseDate(v){ const d = new Date(v); return isNaN(d) ? null : d; }
      function fmtShort(d){ return d.toLocaleDateString(undefined, { month:"short", day:"numeric" }); }

      function escapeHtml(str) {
        return String(str || "")
          .replaceAll("&", "&amp;")
          .replaceAll("<", "&lt;")
          .replaceAll(">", "&gt;")
          .replaceAll('"', "&quot;")
          .replaceAll("'", "&#039;");
      }
      function safeAttr(str) { return String(str || "").replaceAll("'", "%27").replaceAll('"', "%22"); }
    })();
  </script>

</body>
</html>
