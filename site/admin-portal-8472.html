<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8" />
<title>Showroom Market Ops OS</title>
<meta name="viewport" content="width=device-width,initial-scale=1" />
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body style="font-family:Arial;padding:24px;max-width:1200px;margin:auto;">

<h1>Showroom Market Ops OS</h1>

<input type="password" id="adminToken" placeholder="Admin Password">
<button onclick="saveToken()">Unlock</button>
<hr>

<button onclick="loadMetrics()">Refresh Dashboard</button>

<h2>Financial Overview</h2>
<canvas id="financeChart"></canvas>

<h2>Pickup Performance</h2>
<canvas id="pickupChart"></canvas>

<h2>Fraud & Failures</h2>
<canvas id="fraudChart"></canvas>

<h2>Seller Leaderboard</h2>
<pre id="sellerStats"></pre>

<script>
function saveToken(){
  localStorage.setItem("ADMIN_TOKEN",document.getElementById("adminToken").value);
}

function authedFetch(body){
  return fetch("/.netlify/functions/admin",{
    method:"POST",
    headers:{
      "Content-Type":"application/json",
      "Authorization":`Bearer ${localStorage.getItem("ADMIN_TOKEN")}`
    },
    body:JSON.stringify(body)
  }).then(r=>r.json());
}

let financeChart,pickupChart,fraudChart;

async function loadMetrics(){
  const {metrics}=await authedFetch({action:"get_metrics"});

  if(financeChart)financeChart.destroy();
  if(pickupChart)pickupChart.destroy();
  if(fraudChart)fraudChart.destroy();

  financeChart=new Chart(financeChart=document.getElementById("financeChart"),{
    type:"bar",
    data:{labels:["GMV","Fees","Payouts Sent","Payouts Pending"],
    datasets:[{data:[metrics.gmv,metrics.fees,metrics.payouts_sent,metrics.payouts_pending]}]}
  });

  pickupChart=new Chart(document.getElementById("pickupChart"),{
    type:"bar",
    data:{labels:["Today Pickups","Week Pickups","Avg Pickup Days"],
    datasets:[{data:[metrics.today_pickups,metrics.week_pickups,metrics.avg_pickup_days]}]}
  });

  fraudChart=new Chart(document.getElementById("fraudChart"),{
    type:"doughnut",
    data:{labels:["Fraud Attempts","Pickup Failures"],
    datasets:[{data:[metrics.fraud_attempts,metrics.pickup_failures]}]}
  });

  let sellerText="";
  Object.entries(metrics.sellers).forEach(([s,d])=>{
    sellerText+=`${s}: ${d.sales} sales\n`;
  });
  document.getElementById("sellerStats").textContent=sellerText;
}
</script>

</body>
</html>
