<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Showroom Market Admin Portal</title>
<link rel="stylesheet" href="/app.css" />
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
<div class="admin-container">
<h1>ðŸ“Š Showroom Market Admin Dashboard</h1>

<div class="card">
  <h2>Revenue & Disputes Trend</h2>
  <canvas id="gmvChart" height="100"></canvas>
</div>

<div class="card">
  <h2>ðŸš¨ Active Payment Disputes</h2>
  <button id="refreshDisputes" class="btn btn-outline">Refresh</button>
  <button id="copyDisputes" class="btn btn-outline">Copy CSV</button>
  <div class="table-wrap">
    <table class="admin-table" id="disputesTable">
      <thead>
        <tr>
          <th>Listing</th>
          <th>Seller</th>
          <th>Price</th>
          <th>Paid Date</th>
          <th>Status</th>
          <th>Risk</th>
          <th>Action</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>
</div>
</div>

<script>
const ADMIN_TOKEN = localStorage.getItem("admin_token") || prompt("Enter Admin Token:");

async function fetchDisputes() {
  const res = await fetch("/.netlify/functions/admin-get-disputes", {
    headers: { Authorization: "Bearer " + ADMIN_TOKEN }
  });
  return res.json();
}

async function resolveDispute(recordId) {
  if (!confirm("Mark dispute resolved and re-enable payout?")) return;
  await fetch("/.netlify/functions/admin-resolve-dispute", {
    method: "POST",
    headers: {
      "Content-Type": "application/json",
      Authorization: "Bearer " + ADMIN_TOKEN
    },
    body: JSON.stringify({ recordId })
  });
  loadDisputes();
}

async function loadDisputes() {
  const data = await fetchDisputes();
  const tbody = document.querySelector("#disputesTable tbody");
  tbody.innerHTML = "";
  (data.disputes || []).forEach(d => {
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${d.title}</td>
      <td>${d.seller}</td>
      <td>$${d.price}</td>
      <td>${d.paidAt || "-"}</td>
      <td><span class="badge badge-error">Disputed</span></td>
      <td>${d.riskScore}</td>
      <td><button class="btn btn-small btn-primary">Resolve</button></td>`;
    tr.querySelector("button").onclick = () => resolveDispute(d.id);
    tbody.appendChild(tr);
  });
}

document.getElementById("refreshDisputes").onclick = loadDisputes;

document.getElementById("copyDisputes").onclick = async () => {
  const data = await fetchDisputes();
  const rows = [["Listing","Seller","Price","Paid Date","Risk"]];
  (data.disputes || []).forEach(d => rows.push([d.title,d.seller,d.price,d.paidAt,d.riskScore]));
  navigator.clipboard.writeText(rows.map(r => r.join(",")).join("\n"));
  alert("Copied to clipboard");
};

loadDisputes();
</script>
</body>
</html>
