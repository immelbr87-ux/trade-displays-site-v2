<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8" />
<title>Showroom Market Ops Dashboard</title>
<meta name="viewport" content="width=device-width,initial-scale=1" />
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body style="font-family:Arial;padding:24px;max-width:1200px;margin:auto;">

<h1>Showroom Market Operations Dashboard</h1>

<input type="password" id="adminToken" placeholder="Admin Password">
<button onclick="saveToken()">Unlock</button>
<hr>

<button onclick="loadDashboard()">Refresh Dashboard</button>

<h2>Seller Reliability</h2>
<canvas id="sellerChart"></canvas>

<h2>GMV Trend (Last 30 Days)</h2>
<canvas id="gmvChart"></canvas>

<h2>Pickup Delay Heatmap</h2>
<canvas id="delayChart"></canvas>

<script>
function saveToken(){
  localStorage.setItem("ADMIN_TOKEN",document.getElementById("adminToken").value);
}

function authedFetch(body){
  return fetch("/.netlify/functions/admin",{
    method:"POST",
    headers:{
      "Content-Type":"application/json",
      "Authorization":`Bearer ${localStorage.getItem("ADMIN_TOKEN")}`
    },
    body:JSON.stringify(body)
  }).then(r=>r.json());
}

let sellerChart, gmvChart, delayChart;

async function loadDashboard(){
  const data = await authedFetch({});
  const sellers = data.sellers;
  const gmv = data.gmvByDay;
  const delays = data.pickupDelays;

  // Seller Chart
  if(sellerChart) sellerChart.destroy();
  sellerChart = new Chart(document.getElementById("sellerChart"),{
    type:"bar",
    data:{
      labels:Object.keys(sellers),
      datasets:[{
        label:"Seller Score",
        data:Object.values(sellers).map(s=>s.score)
      }]
    }
  });

  // GMV Trend
  if(gmvChart) gmvChart.destroy();
  gmvChart = new Chart(document.getElementById("gmvChart"),{
    type:"line",
    data:{
      labels:Object.keys(gmv),
      datasets:[{
        label:"GMV",
        data:Object.values(gmv)
      }]
    }
  });

  // Pickup Delay Heatmap (Histogram)
  const bins = [0,1,2,3,4,5,7,10];
  const counts = bins.map((b,i)=>delays.filter(d=>d>=b && d<(bins[i+1]||999)).length);

  if(delayChart) delayChart.destroy();
  delayChart = new Chart(document.getElementById("delayChart"),{
    type:"bar",
    data:{
      labels:["0-1d","1-2d","2-3d","3-4d","4-5d","5-7d","7-10d","10+d"],
      datasets:[{label:"Pickup Delay Distribution",data:counts}]
    }
  });
}
</script>

</body>
</html>
