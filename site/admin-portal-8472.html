<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <title>Admin â€“ Seller Onboarding + Payout</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; padding: 24px; max-width: 900px; margin: 0 auto; }
    h1 { font-size: 22px; margin-bottom: 8px; }
    h2 { font-size: 18px; margin-top: 28px; }
    .small { color: #666; font-size: 14px; line-height: 1.35; }
    .card { border: 1px solid #e5e5e5; border-radius: 12px; padding: 16px; margin-top: 12px; background: #fff; }
    label { display:block; font-weight: 600; margin: 12px 0 6px; }
    input { width: 100%; max-width: 520px; padding: 10px 12px; font-size: 16px; border: 1px solid #ddd; border-radius: 10px; }
    button { padding: 10px 14px; font-size: 16px; border: 1px solid #111; border-radius: 10px; background: #111; color: #fff; cursor: pointer; margin-right: 10px; }
    button.secondary { background:#fff; color:#111; }
    button:disabled { opacity: 0.5; cursor: not-allowed; }
    .row { margin-top: 14px; }
    .status { margin-top: 14px; padding: 12px; border: 1px solid #eee; border-radius: 10px; background: #fafafa; white-space: pre-wrap; }
    code { background: #f3f3f3; padding: 2px 6px; border-radius: 6px; }
  </style>
</head>
<body>

<!-- ðŸ” PASSWORD GATE -->
<div id="gate" style="position:fixed;inset:0;background:#0b0b0b;display:flex;align-items:center;justify-content:center;z-index:99999;">
  <div style="width:min(520px,92vw);background:#111;border:1px solid #2a2a2a;border-radius:16px;padding:18px;color:#fff;">
    <div style="font-size:18px;font-weight:700;margin-bottom:8px;">Admin Access Required</div>
    <input id="gatePass" type="password" placeholder="Enter Admin Passcode"
      style="width:100%;padding:12px;border-radius:12px;border:1px solid #333;background:#0b0b0b;color:#fff;font-size:16px;" />
    <div style="margin-top:12px;display:flex;gap:10px;align-items:center;">
      <button id="gateBtn" style="padding:10px 14px;border-radius:12px;border:1px solid #fff;background:#fff;color:#111;font-weight:700;cursor:pointer;">Unlock</button>
      <div id="gateMsg" style="color:#ffb4b4;font-size:14px;"></div>
    </div>
  </div>
</div>

<!-- ðŸ”“ ACTUAL ADMIN PAGE -->
<div id="adminApp" style="display:none;">

  <h1>Admin â€“ Seller Onboarding + Payout</h1>

  <div class="card">
    <h2>1) Airtable Record</h2>
    <label>Airtable recordId</label>
    <input id="recordId" placeholder="recXXXXXXXXXXXXXX" />
    <div class="row">
      <button id="saveRecordIdBtn" class="secondary">Save recordId</button>
      <button id="clearSavedBtn" class="secondary">Clear saved</button>
    </div>
    <div id="recordStatus" class="status">Status: waitingâ€¦</div>
  </div>

  <div class="card">
    <h2>2) Seller Stripe Onboarding</h2>
    <label>Seller name</label>
    <input id="sellerName" placeholder="Showroom LLC" />
    <label>Seller email</label>
    <input id="sellerEmail" placeholder="seller@email.com" />
    <div class="row">
      <button id="startOnboardingBtn">Start Stripe Onboarding</button>
    </div>
    <div id="onboardingStatus" class="status">Status: waitingâ€¦</div>
  </div>

  <div class="card">
    <h2>3) Send Seller Payout</h2>
    <button id="sendPayoutBtn">Send Payout</button>
    <div id="payoutStatus" class="status">Status: waitingâ€¦</div>
  </div>

</div>

<script>
// ðŸ” CHANGE PASSWORD HERE
const ADMIN_PASSCODE = "SR2026BargainBond!";

// Gate logic
const gate = document.getElementById("gate");
const adminApp = document.getElementById("adminApp");
const gatePass = document.getElementById("gatePass");
const gateBtn = document.getElementById("gateBtn");
const gateMsg = document.getElementById("gateMsg");

function unlock() {
  gate.style.display = "none";
  adminApp.style.display = "block";
  sessionStorage.setItem("admin_unlocked", "1");
}

if (sessionStorage.getItem("admin_unlocked") === "1") unlock();

gateBtn.addEventListener("click", () => {
  if (gatePass.value.trim() === ADMIN_PASSCODE) unlock();
  else gateMsg.textContent = "Incorrect passcode.";
});

// Existing admin JS logic continues below
const $ = id => document.getElementById(id);
const recordStatus = $("recordStatus");
const onboardingStatus = $("onboardingStatus");
const payoutStatus = $("payoutStatus");

function setStatus(el, msg) { el.textContent = msg; }

function getRecordId() {
  const id = $("recordId").value.trim();
  if (!id.startsWith("rec")) throw new Error("Invalid recordId");
  return id;
}

$("saveRecordIdBtn").onclick = () => {
  try { localStorage.setItem("admin_recordId", getRecordId()); setStatus(recordStatus, "Saved recordId"); }
  catch(e){ setStatus(recordStatus, e.message); }
};

$("clearSavedBtn").onclick = () => {
  localStorage.removeItem("admin_recordId");
  $("recordId").value = "";
  setStatus(recordStatus, "Cleared saved recordId");
};

$("startOnboardingBtn").onclick = async () => {
  try {
    const recordId = getRecordId();
    const sellerName = $("sellerName").value;
    const sellerEmail = $("sellerEmail").value;
    setStatus(onboardingStatus, "Creating Stripe account...");
    const res = await fetch("/.netlify/functions/createConnectAccount", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ sellerName, sellerEmail, recordId })
    });
    const data = await res.json();
    if (!res.ok) throw new Error(data.error || "Failed");
    setStatus(onboardingStatus, "Account created. Redirecting...");
    window.location.href = data.onboarding_url;
  } catch (e) { setStatus(onboardingStatus, "Error: " + e.message); }
};

$("sendPayoutBtn").onclick = async () => {
  try {
    const recordId = getRecordId();
    setStatus(payoutStatus, "Sending payout...");
    const res = await fetch("/.netlify/functions/sendSellerPayout", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ recordId })
    });
    const data = await res.json();
    if (!res.ok) throw new Error(data.error || "Failed");
    setStatus(payoutStatus, "Success â€” transfer_id: " + data.transfer_id);
  } catch (e) { setStatus(payoutStatus, "Error: " + e.message); }
};
</script>

</body>
</html>
