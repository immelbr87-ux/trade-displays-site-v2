<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <title>Showroom Market Admin Portal</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />

  <!-- Chart.js CDN -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body style="font-family: Arial; padding: 24px; max-width: 1200px; margin:auto;">

<h1>Showroom Market Admin Portal</h1>

<label>Admin Password:</label>
<input type="password" id="adminToken" style="width:320px;padding:8px;">
<button onclick="saveToken()">Unlock</button>
<span id="tokenStatus"></span>

<hr>

<div style="margin:20px 0;">
  <button onclick="showTab('pickup')">Pickup Scan</button>
  <button onclick="showTab('ops')">Pickup Ops</button>
  <button onclick="showTab('metrics')">Ops Metrics</button>
</div>

<!-- PICKUP SCAN -->
<div id="pickupTab">
  <h2>Scan Pickup QR</h2>
  <input id="payload" placeholder="SMK|recXXXX|token" style="width:420px;padding:10px;">
  <button onclick="verify()">Verify & Pay</button>
  <pre id="out" style="background:#111;color:#0f0;padding:12px;"></pre>
</div>

<!-- PICKUP OPS -->
<div id="opsTab" style="display:none;">
  <h2>Pickup Operations</h2>
  <button onclick="loadOps()">Refresh</button>
  <pre id="opsOut"></pre>
</div>

<!-- METRICS DASHBOARD -->
<div id="metricsTab" style="display:none;">
  <h2>Operations Metrics Dashboard</h2>
  <button onclick="loadMetrics()">Refresh Metrics</button>

  <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(300px,1fr));gap:30px;margin-top:20px;">
    <canvas id="todayChart"></canvas>
    <canvas id="weekChart"></canvas>
    <canvas id="healthChart"></canvas>
  </div>
</div>

<script>
function saveToken() {
  localStorage.setItem("ADMIN_TOKEN", document.getElementById("adminToken").value);
  document.getElementById("tokenStatus").innerText = "Saved âœ”";
}

function authedFetch(url, options={}) {
  options.headers = {
    ...(options.headers||{}),
    "Content-Type":"application/json",
    "Authorization":`Bearer ${localStorage.getItem("ADMIN_TOKEN")}`
  };
  return fetch(url, options);
}

function showTab(tab) {
  document.getElementById("pickupTab").style.display = tab==="pickup"?"block":"none";
  document.getElementById("opsTab").style.display = tab==="ops"?"block":"none";
  document.getElementById("metricsTab").style.display = tab==="metrics"?"block":"none";
}

async function verify() {
  const payload = document.getElementById("payload").value;
  const res = await authedFetch("/.netlify/functions/admin", {
    method:"POST",
    body:JSON.stringify({ action:"verify_pickup_and_payout", payload })
  });
  document.getElementById("out").textContent = JSON.stringify(await res.json(),null,2);
}

async function loadOps() {
  const res = await authedFetch("/.netlify/functions/admin", {
    method:"POST",
    body:JSON.stringify({ action:"get_ops" })
  });
  document.getElementById("opsOut").textContent = JSON.stringify(await res.json(),null,2);
}

let todayChart, weekChart, healthChart;

async function loadMetrics() {
  const res = await authedFetch("/.netlify/functions/admin", {
    method:"POST",
    body:JSON.stringify({ action:"get_metrics" })
  });
  const data = await res.json();
  const m = data.metrics;

  // Destroy old charts if reloading
  if (todayChart) todayChart.destroy();
  if (weekChart) weekChart.destroy();
  if (healthChart) healthChart.destroy();

  // Today chart
  todayChart = new Chart(document.getElementById('todayChart'), {
    type: 'bar',
    data: {
      labels: ['Pickups Today', 'Payouts Today', 'Failed Scans Today'],
      datasets: [{
        label: 'Today',
        data: [m.today_pickups, m.today_payouts, m.today_failed_scans],
        backgroundColor: ['#4CAF50','#2196F3','#F44336']
      }]
    }
  });

  // Weekly performance chart
  weekChart = new Chart(document.getElementById('weekChart'), {
    type: 'bar',
    data: {
      labels: ['Pickups (7d)', 'Failed Scans (7d)'],
      datasets: [{
        label: 'Last 7 Days',
        data: [m.week_pickups, m.week_failed_scans],
        backgroundColor: ['#8BC34A','#FF5722']
      }]
    }
  });

  // System health
  healthChart = new Chart(document.getElementById('healthChart'), {
    type: 'doughnut',
    data: {
      labels: ['Pending Pickups', 'Payout Errors'],
      datasets: [{
        data: [m.pending_pickups, m.payout_errors],
        backgroundColor: ['#FFC107','#E91E63']
      }]
    }
  });
}
</script>

</body>
</html>
