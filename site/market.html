<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Browse Displays ‚Äî Trade Displays by Bargain Bond</title>
  <meta name="description" content="Browse upcoming showroom display removals. Trade-only, fixed pricing, local pickup. Funds held in escrow until pickup confirmation." />
  <link rel="stylesheet" href="/app.css" />
</head>
<body>

  <div class="topbar">
    <div class="container topbar-inner">
      <a class="brand" href="/">
        <div class="logo">B</div>
        <div>TRADE DISPLAYS <small>by Bargain Bond</small></div>
      </a>

      <div class="navlinks" aria-label="Primary">
        <a href="/market" class="active">Browse displays</a>
        <a href="/for-showrooms">For showrooms</a>
        <a href="/brand-compliance">Brand compliance</a>
        <a href="/faq">FAQ</a>
        <a href="/pilot">Pilot</a>
      </div>

      <div class="navcta">
        <a class="btn btn-ghost" href="#signin">Sign In</a>
        <a class="btn btn-primary" href="#create">Create Account</a>
      </div>
    </div>
  </div>

  <div class="container pagewrap">
    <div class="page-hero">
      <div class="page-hero-inner">
        <div>
          <div class="kicker"><span class="dot"></span> Upcoming removals ‚Ä¢ verified trade buyers ‚Ä¢ pickup window upfront</div>
          <h1>Browse upcoming displays</h1>
          <p class="lede">
            These are installed showroom displays scheduled for removal. Listings are specs-first (dimensions, rough-in, finish family, grade).
            Brand identifiers can be limited in the pilot to reduce exposure.
          </p>
        </div>

        <div class="page-hero-actions">
          <a class="btn btn-pill btn-primary" href="/faq">How it works</a>
          <a class="btn btn-pill" href="/for-showrooms">List upcoming removals</a>
        </div>
      </div>
    </div>

    <div style="height:18px"></div>

    <div class="market-shell">
      <!-- LEFT: listings -->
      <div>
        <div class="chiprow" aria-label="Active filters">
          <span class="chip">Local pickup</span>
          <span class="chip">Fixed price</span>
          <span class="chip">No returns</span>
          <span class="chip">Escrow until pickup</span>
        </div>

        <div style="height:14px"></div>

        <!-- Live listings render here -->
        <div class="listings" id="listings" aria-label="Listings">
          <div class="muted">Loading listings‚Ä¶</div>
        </div>
      </div>

      <!-- RIGHT: filter panel -->
      <aside class="panel" aria-label="Filters">
        <h3>Filters (pilot)</h3>
        <div class="muted small">These filters are placeholders for the MVP. The goal is credibility + clarity, not a full marketplace yet.</div>

        <div class="formrow" style="margin-top:14px;">
          <div>
            <div class="label">Category</div>
            <select class="select" aria-label="Category">
              <option>All</option>
              <option>Vanities</option>
              <option>Faucets</option>
              <option>Sinks</option>
              <option>Showers</option>
              <option>Toilets</option>
            </select>
          </div>

          <div>
            <div class="label">Condition grade</div>
            <select class="select" aria-label="Grade">
              <option>All</option>
              <option>Grade A</option>
              <option>Grade B</option>
            </select>
          </div>

          <div>
            <div class="label">Pickup timing</div>
            <select class="select" aria-label="Pickup timing">
              <option>Any</option>
              <option>Within 2 weeks</option>
              <option>Within 4 weeks</option>
              <option>4‚Äì8 weeks</option>
            </select>
          </div>

          <div>
            <div class="label">Location</div>
            <input class="input" placeholder="City or ZIP (e.g., 53226)" aria-label="Location" />
          </div>
        </div>

        <div style="height:12px"></div>

        <a class="btn btn-dark btn-full btn-pill" href="#apply">Apply (stub)</a>

        <div class="callout" style="margin-top:14px;">
          <strong>Trade-only access</strong>
          <div class="small muted">
            Buyers are verified (contractors, builders, remodelers, designers sourcing installs, property managers).
          </div>
        </div>

        <div class="chiprow">
          <span class="chip">No bidding</span>
          <span class="chip">No returns</span>
          <span class="chip">Pickup confirmed</span>
        </div>

        <div class="small muted2" style="margin-top:10px;line-height:1.55;">
          Want to list upcoming removals? Showrooms use a specs-first template to reduce brand exposure.
          <a href="/for-showrooms" style="text-decoration:underline;">See how it works</a>.
        </div>
      </aside>
    </div>

    <div class="footer">
      <div class="hr"></div>
      <div class="fine">
        Trade Displays is operated by Bargain Bond. We facilitate escrow and commitment for scheduled showroom display removals.
      </div>
      <div class="footer-nav" aria-label="Footer navigation">
        <a href="/">Home</a>
        <a href="/market">Browse displays</a>
        <a href="/for-showrooms">For showrooms</a>
        <a href="/brand-compliance">Brand compliance</a>
        <a href="/faq">FAQ</a>
        <a href="/pilot">Pilot</a>
      </div>
    </div>
  </div>

  <!-- LIVE AIRTABLE LISTINGS -->
  <script>
    (async function () {
      const root = document.getElementById("listings");
      if (!root) return;

      root.innerHTML = '<div class="muted">Loading listings‚Ä¶</div>';

      try {
        // This must exist: netlify/functions/listings.js
        const r = await fetch("/.netlify/functions/listDisplays?pageSize=12", { cache: "no-store" });
        const data = await r.json();

        if (!r.ok) throw new Error(data?.error || "Failed to load listings.");

        const listings = Array.isArray(data.listings) ? data.listings : [];
        if (!listings.length) {
          root.innerHTML = '<div class="muted">No active listings yet.</div>';
          return;
        }

        root.innerHTML = listings.map(renderListingCard).join("");

      } catch (err) {
        console.error(err);
        root.innerHTML = `
          <div class="muted">
            Could not load listings. Check:
            <ul>
              <li>Netlify env vars set (AIRTABLE_TOKEN, AIRTABLE_BASE_ID, etc.)</li>
              <li>Airtable view name matches <strong>Public_Active</strong></li>
              <li>At least one record matches view filters</li>
            </ul>
          </div>
        `;
      }

      function renderListingCard(x) {
        const id = x.id || "";
        const title = safeText(x.title || "Display Listing");
        const price = (x.price != null && x.price !== "") ? `$${Number(x.price).toLocaleString()}` : "";
        const grade = safeText(x.condition_grade || "?");
        const category = safeText(x.category || "Display");
        const finish = safeText(x.finish_family || "Specs-first listing");
        const dimensions = safeText(x.dimensions || "");
        const keySpec = safeText(x.key_spec || "");
        const pickupText = pickupWindowText(x.pickup_window_start, x.pickup_window_end);

        const thumb = safeAttr(x.thumbnail_url || "");
        const thumbStyle = thumb ? `background-image:url('${thumb}')` : `background-image:linear-gradient(180deg, rgba(11,18,32,.15), rgba(11,18,32,.35))`;

        // Fake pages you will add next:
        // listing-details.html?id=REC_ID
        // reserve-confirmation.html?id=REC_ID
        return `
          <div class="listing">
            <div class="thumb" style="${thumbStyle}">
              <div class="thumb-badges">
                <span class="pilltag ok">Grade ${grade}</span>
                <span class="pilltag soft">${safeText(pickupText)}</span>
              </div>
            </div>

            <div class="listing-body">
              <div class="title">
                <h3>${title}</h3>
                <div class="price">${safeText(price)}</div>
              </div>

              <div class="meta">
                <div>üè∑Ô∏è ${finish}</div>
                <div>üìç Local pickup</div>
                <div>üóìÔ∏è ${safeText(pickupWindowDateLine(x.pickup_window_start, x.pickup_window_end))}</div>
                <div>üìè ${dimensions || keySpec || "Specs disclosed"}</div>
              </div>

              <div class="divider"></div>

              <div class="actions">
                <a class="btn btn-primary btn-pill" href="/reserve-confirmation?id=${encodeURIComponent(id)}">Reserve</a>
                <a class="btn btn-pill" href="/listing-details?id=${encodeURIComponent(id)}">View details</a>
              </div>

              <div class="subnote">
  Funds held until pickup confirmation. Buyer inspects at pickup before acceptance. Final sale once accepted.
  <span class="muted">Condition grades describe cosmetic condition only and do not create a warranty or guarantee.</span>
</div>
        `;
      }

      function pickupWindowText(start, end) {
        // Keep your ‚ÄúPickup in X‚ÄìY days‚Äù vibe, but safe if dates missing
        const s = parseDate(start);
        const e = parseDate(end);
        if (!s || !e) return "Pickup window set";
        const now = new Date();
        const d1 = Math.max(0, Math.round((s - now) / 86400000));
        const d2 = Math.max(0, Math.round((e - now) / 86400000));
        const a = Math.min(d1, d2);
        const b = Math.max(d1, d2);
        if (a === b) return `Pickup in ~${a} days`;
        return `Pickup in ${a}‚Äì${b} days`;
      }

      function pickupWindowDateLine(start, end) {
        const s = parseDate(start);
        const e = parseDate(end);
        if (!s || !e) return "Window: shown after reserve";
        return `Window: ${fmtShort(s)}‚Äì${fmtShort(e)}`;
      }

      function parseDate(v) {
        const d = new Date(v);
        return isNaN(d) ? null : d;
      }

      function fmtShort(d) {
        return d.toLocaleDateString(undefined, { month: "short", day: "numeric" });
      }

      function safeText(str) {
        return String(str || "")
          .replaceAll("&", "&amp;")
          .replaceAll("<", "&lt;")
          .replaceAll(">", "&gt;")
          .replaceAll('"', "&quot;")
          .replaceAll("'", "&#039;");
      }

      function safeAttr(str) {
        return String(str || "").replaceAll("'", "%27").replaceAll('"', "%22");
      }
    })();
  </script>

</body>
</html>
