<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Browse Products - SHOWROOM MARKET | Kitchen & Bath Floor Models</title>
  <meta name="description" content="Browse premium kitchen and bath showroom floor models. Cabinetry, vanities, appliances, fixtures from top brands. Wholesale prices for trade professionals.">
  <link rel="stylesheet" href="app.css">
</head>
<body>
  
  <!-- Header inserted via include.js -->
  
  <section class="container" style="padding: 3rem 0;">
    <h1 style="margin-bottom: 1rem;">Browse Premium Products</h1>
    <p style="color: var(--text-muted); margin-bottom: 2rem;">Kitchen and bath floor models from top showrooms nationwide.</p>
    
    <!-- Filters -->
    <div class="filters">
      <div class="search-box">
        <input type="text" id="searchInput" placeholder="Search kitchen & bath products...">
      </div>
      
      <div class="filter-group">
        <label style="font-weight: 600; margin-right: 0.5rem;">Category:</label>
        <select class="form-select" id="categoryFilter" style="width: auto; padding: 0.625rem 1rem;">
          <option value="all">All Categories</option>
          <option value="cabinetry">Kitchen Cabinetry</option>
          <option value="vanities">Bathroom Vanities</option>
          <option value="faucets">Luxury Faucets</option>
          <option value="sinks">Kitchen Sinks</option>
          <option value="appliances">High-End Appliances</option>
          <option value="shower-tub">Shower & Tub Systems</option>
          <option value="countertops">Countertops & Surfaces</option>
          <option value="hardware">Hardware & Fixtures</option>
        </select>
      </div>
      
      <div class="filter-group">
        <label style="font-weight: 600; margin-right: 0.5rem;">Type:</label>
        <button class="filter-btn active" data-filter="all">All</button>
        <button class="filter-btn" data-filter="rent">Rent</button>
        <button class="filter-btn" data-filter="buy">Buy</button>
      </div>
      
      <div class="filter-group">
        <label style="font-weight: 600; margin-right: 0.5rem;">Size:</label>
        <select class="form-select" id="sizeFilter" style="width: auto; padding: 0.625rem 1rem;">
          <option value="all">All Sizes</option>
          <option value="10x10">10x10</option>
          <option value="10x20">10x20</option>
          <option value="20x20">20x20</option>
          <option value="30x30">30x30</option>
          <option value="custom">Custom</option>
        </select>
      </div>
      
      <div class="filter-group">
        <label style="font-weight: 600; margin-right: 0.5rem;">Sort:</label>
        <select class="form-select" id="sortSelect" style="width: auto; padding: 0.625rem 1rem;">
          <option value="newest">Newest First</option>
          <option value="price-low">Price: Low to High</option>
          <option value="price-high">Price: High to Low</option>
          <option value="popular">Most Popular</option>
        </select>
      </div>
    </div>
    
    <div id="resultsCount" style="margin: 2rem 0 1rem; color: var(--text-muted); font-weight: 500;">
      Loading...
    </div>
    
    <!-- Displays Grid -->
    <div id="displaysGrid" class="product-grid">
      <div class="loading">
        <div class="spinner"></div>
        <p>Loading products...</p>
      </div>
    </div>
    
    <!-- Empty State -->
    <div id="emptyState" class="hidden" style="text-align: center; padding: 4rem 2rem;">
      <div style="font-size: 4rem; margin-bottom: 1rem;">üîç</div>
      <h3>No products found</h3>
      <p style="color: var(--text-muted); margin-top: 0.5rem;">Try adjusting your filters or search criteria.</p>
      <button onclick="resetFilters()" class="btn btn-outline" style="margin-top: 1.5rem;">Reset Filters</button>
    </div>
  </section>

  <!-- Footer inserted via include.js -->
  
  <script src="shared/include.js"></script>
  <script>
    let allDisplays = [];
    let currentFilter = 'all';
    let currentCategory = 'all';
    let currentSize = 'all';
    let currentSort = 'newest';
    let searchQuery = '';

    // Fetch displays from Netlify Function
    async function loadDisplays() {
      try {
        const response = await fetch('/.netlify/functions/listDisplays');
        const data = await response.json();
        allDisplays = data.displays;
        
        filterAndRenderDisplays();
      } catch (error) {
        console.error('Error loading displays:', error);
        document.getElementById('displaysGrid').innerHTML = `
          <div style="text-align: center; padding: 2rem; grid-column: 1 / -1;">
            <p style="color: var(--error);">Unable to load products. Please try again later.</p>
          </div>
        `;
      }
    }

    // Filter and render displays
    function filterAndRenderDisplays() {
      let filtered = [...allDisplays];
      
      // Apply category filter
      if (currentCategory !== 'all') {
        filtered = filtered.filter(d => {
          const category = d.category?.toLowerCase() || '';
          const size = d.size?.toLowerCase() || '';
          const name = d.name?.toLowerCase() || '';
          
          // Match category by name, size, or explicit category field
          return category.includes(currentCategory.toLowerCase()) ||
                 size.includes(currentCategory.toLowerCase()) ||
                 name.includes(currentCategory.toLowerCase());
        });
      }
      
      // Apply type filter
      if (currentFilter !== 'all') {
        filtered = filtered.filter(d => d.listingType === currentFilter);
      }
      
      // Apply size filter
      if (currentSize !== 'all') {
        filtered = filtered.filter(d => d.size?.toLowerCase().includes(currentSize.toLowerCase()));
      }
      
      // Apply search
      if (searchQuery) {
        filtered = filtered.filter(d => 
          d.name.toLowerCase().includes(searchQuery.toLowerCase()) ||
          d.description?.toLowerCase().includes(searchQuery.toLowerCase())
        );
      }
      
      // Sort
      switch(currentSort) {
        case 'price-low':
          filtered.sort((a, b) => a.price - b.price);
          break;
        case 'price-high':
          filtered.sort((a, b) => b.price - a.price);
          break;
        case 'popular':
          filtered.sort((a, b) => (b.views || 0) - (a.views || 0));
          break;
        case 'newest':
        default:
          filtered.sort((a, b) => new Date(b.createdAt || 0) - new Date(a.createdAt || 0));
      }
      
      renderDisplays(filtered);
      updateResultsCount(filtered.length);
    }

    // Render displays with Swappa-style spec lists
    function renderDisplays(displays) {
      const grid = document.getElementById('displaysGrid');
      const emptyState = document.getElementById('emptyState');
      
      if (displays.length === 0) {
        grid.classList.add('hidden');
        emptyState.classList.remove('hidden');
        return;
      }
      
      grid.classList.remove('hidden');
      emptyState.classList.add('hidden');
      
      grid.innerHTML = displays.map(display => {
        // Extract city from location (if full address provided)
        const location = display.location || 'Location TBD';
        const cityOnly = location.split(',').slice(-2).join(',').trim() || location;
        
        // Get condition grade
        const grade = display.condition || 'Grade A';
        const availability = display.availability || 'Available Now';
        
        return `
        <div class="product-card" onclick="window.location.href='listing-details.html?id=${display.id}'">
          <div class="product-image" style="background: linear-gradient(135deg, #e5e7eb 0%, #d1d5db 100%);">
            <div class="product-badges">
              <span class="badge badge-grade">${grade}</span>
              <span class="badge badge-pickup">${availability}</span>
            </div>
          </div>
          <div class="product-info">
            <div class="product-name">${display.name}</div>
            
            <!-- Swappa-style spec list -->
            <ul class="product-specs">
              <li><strong>Size:</strong> ${display.size || 'N/A'}</li>
              <li><strong>Condition:</strong> ${display.condition || 'N/A'}</li>
              <li><strong>Brand:</strong> ${display.brand || 'Various'}</li>
              <li><strong>Location:</strong> ${cityOnly}</li>
              <li><strong>Available:</strong> ${availability}</li>
            </ul>
            
            <div class="product-price">$${display.price.toLocaleString()}${display.listingType === 'rent' ? '/week' : ''}</div>
            <div class="product-actions">
              <a href="reserve-confirmation.html?id=${display.id}" class="btn btn-primary btn-small" onclick="event.stopPropagation()">Reserve</a>
              <a href="listing-details.html?id=${display.id}" class="btn btn-secondary btn-small" onclick="event.stopPropagation()">Details</a>
            </div>
          </div>
        </div>
      `;
      }).join('');
    }

    // Update results count
    function updateResultsCount(count) {
      document.getElementById('resultsCount').textContent = 
        `Showing ${count} ${count === 1 ? 'product' : 'products'}`;
    }

    // Reset filters
    function resetFilters() {
      currentFilter = 'all';
      currentCategory = 'all';
      currentSize = 'all';
      currentSort = 'newest';
      searchQuery = '';
      
      document.querySelectorAll('.filter-btn').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.filter === 'all');
      });
      document.getElementById('categoryFilter').value = 'all';
      document.getElementById('sizeFilter').value = 'all';
      document.getElementById('sortSelect').value = 'newest';
      document.getElementById('searchInput').value = '';
      
      // Update URL
      window.history.replaceState({}, '', 'market.html');
      
      filterAndRenderDisplays();
    }

    // Event listeners
    document.addEventListener('DOMContentLoaded', () => {
      // Category filter
      document.getElementById('categoryFilter').addEventListener('change', (e) => {
        currentCategory = e.target.value;
        filterAndRenderDisplays();
      });
      
      // Type filter buttons
      document.querySelectorAll('.filter-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
          btn.classList.add('active');
          currentFilter = btn.dataset.filter;
          filterAndRenderDisplays();
        });
      });
      
      // Size filter
      document.getElementById('sizeFilter').addEventListener('change', (e) => {
        currentSize = e.target.value;
        filterAndRenderDisplays();
      });
      
      // Sort select
      document.getElementById('sortSelect').addEventListener('change', (e) => {
        currentSort = e.target.value;
        filterAndRenderDisplays();
      });
      
      // Search input with debounce
      let searchTimeout;
      document.getElementById('searchInput').addEventListener('input', (e) => {
        clearTimeout(searchTimeout);
        searchTimeout = setTimeout(() => {
          searchQuery = e.target.value;
          filterAndRenderDisplays();
        }, 300);
      });
      
      // Check URL parameters for filters
      const urlParams = new URLSearchParams(window.location.search);
      
      // Check for category parameter
      const categoryParam = urlParams.get('category');
      if (categoryParam) {
        currentCategory = categoryParam;
        document.getElementById('categoryFilter').value = categoryParam;
      }
      
      // Check for filter parameter
      const filterParam = urlParams.get('filter');
      if (filterParam && ['all', 'rent', 'buy'].includes(filterParam)) {
        currentFilter = filterParam;
        document.querySelectorAll('.filter-btn').forEach(btn => {
          btn.classList.toggle('active', btn.dataset.filter === filterParam);
        });
      }
      
      // Load displays
      loadDisplays();
    });
  </script>
</body>
</html>
