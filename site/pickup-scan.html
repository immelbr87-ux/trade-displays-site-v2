<!-- site/pickup-scan.html -->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Showroom Market — Pickup QR Scanner</title>

  <style>
    :root{
      --bg:#0b1220;
      --card:#111b33;
      --border:rgba(255,255,255,.10);
      --text:#e8eefc;
      --muted:rgba(232,238,252,.75);
      --ok:rgba(0,200,120,.15);
      --okBorder:rgba(0,200,120,.35);
      --bad:rgba(255,80,80,.15);
      --badBorder:rgba(255,80,80,.35);
      --btn:#2b6cff;
      --btn2:#1f2b4d;
    }
    *{ box-sizing:border-box; }
    body{
      margin:0;
      background:var(--bg);
      color:var(--text);
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
    }
    .wrap{ max-width:980px; margin:0 auto; padding:22px; }
    h1{ margin:0 0 8px; font-size:22px; }
    p{ margin:6px 0; color:var(--muted); }
    .grid{ display:flex; gap:16px; flex-wrap:wrap; }
    .col{ flex:1 1 360px; min-width: 300px; }
    .card{
      background:var(--card);
      border:1px solid var(--border);
      border-radius:14px;
      padding:16px;
      margin: 14px 0;
      box-shadow: 0 8px 22px rgba(0,0,0,.25);
    }
    label{ display:block; margin:10px 0 6px; font-size:13px; color:var(--muted); }
    input, textarea, button{
      width:100%;
      border-radius:10px;
      border:1px solid rgba(255,255,255,.12);
      background:var(--bg);
      color:var(--text);
      padding:12px;
      font-size:14px;
    }
    textarea{ resize:vertical; min-height:120px; }
    .btnRow{ display:flex; gap:10px; margin-top:10px; flex-wrap:wrap; }
    button{
      cursor:pointer;
      background:var(--btn);
      border:none;
      font-weight:800;
      letter-spacing:.2px;
    }
    button.secondary{
      background:var(--btn2);
      border:1px solid rgba(255,255,255,.12);
      font-weight:700;
    }
    button.small{ padding:10px 12px; width:auto; }
    .status{
      padding:10px 12px;
      border-radius:10px;
      border:1px solid rgba(255,255,255,.10);
      background:rgba(255,255,255,.06);
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      white-space:pre-wrap;
      word-break:break-word;
    }
    .ok{ background:var(--ok); border-color:var(--okBorder); }
    .bad{ background:var(--bad); border-color:var(--badBorder); }
    .mono{ font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
    #reader{
      width:100%;
      min-height:320px;
      border-radius:14px;
      overflow:hidden;
      border:1px solid rgba(255,255,255,.12);
      background:#070b14;
    }
    .hint{ font-size:12px; color:rgba(232,238,252,.65); }
    .kbd{
      display:inline-block;
      padding:2px 8px;
      border:1px solid rgba(255,255,255,.14);
      border-radius:8px;
      background:rgba(255,255,255,.06);
      font-size:12px;
      margin:0 4px;
    }
  </style>

  <!-- QR scanner lib -->
  <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
</head>

<body>
  <div class="wrap">
    <h1>Pickup QR Scanner</h1>
    <p>Scan the buyer’s QR code to confirm pickup (server-verified). Requires admin password.</p>

    <div class="card">
      <div class="grid">
        <div class="col">
          <label>Admin Password (stores in this tab only)</label>
          <input id="adminToken" type="password" placeholder="Enter admin password…" />
          <div class="btnRow">
            <button class="small" id="unlockBtn" type="button">Unlock</button>
            <button class="secondary small" id="lockBtn" type="button">Lock</button>
          </div>
          <p class="hint">
            Stored in <span class="kbd">sessionStorage</span> (clears when tab closes).
          </p>

          <div style="margin-top:12px" class="status" id="authStatus">Locked. Enter admin password.</div>
        </div>

        <div class="col">
          <label>QR Payload (auto-fills when scanned)</label>
          <textarea id="payload" class="mono" placeholder="SMK|recXXXXXXXXXXXXXX|token"></textarea>
          <div class="btnRow">
            <button class="secondary small" id="verifyBtn" type="button">Verify + Confirm Pickup</button>
            <button class="secondary small" id="startBtn" type="button">Start Camera</button>
            <button class="secondary small" id="stopBtn" type="button">Stop</button>
          </div>
          <p class="hint">
            Expected format: <span class="kbd">SMK|LISTING_ID|QR_TOKEN</span>
          </p>
        </div>
      </div>
    </div>

    <div class="card">
      <div id="reader"></div>
      <p class="hint" style="margin-top:10px;">
        If camera won’t start: allow camera permissions, use HTTPS, or try Chrome/Safari.
      </p>
    </div>

    <div class="card">
      <label>Server Response</label>
      <div class="status" id="result">Waiting…</div>
    </div>
  </div>

  <script>
    const TOKEN_KEY = "smk_admin_token";
    const readerId = "reader";
    const authStatus = document.getElementById("authStatus");
    const resultBox = document.getElementById("result");
    const payloadEl = document.getElementById("payload");
    const adminTokenEl = document.getElementById("adminToken");

    let html5QrCode = null;
    let scanning = false;

    // ✅ Prevent multiple scan fires / multiple submits
    let verifyInFlight = false;
    let lastPayload = "";
    let lastPayloadAt = 0;

    function setStatus(el, msg, cls="") {
      el.className = "status " + cls;
      el.textContent = msg;
    }

    function getToken() {
      return sessionStorage.getItem(TOKEN_KEY) || "";
    }

    function setToken(t) {
      if (!t) sessionStorage.removeItem(TOKEN_KEY);
      else sessionStorage.setItem(TOKEN_KEY, t);
      refreshAuth();
    }

    function refreshAuth() {
      const tok = getToken();
      if (tok) setStatus(authStatus, "Unlocked ✅ Ready to scan.", "ok");
      else setStatus(authStatus, "Locked. Enter admin password.", "");
    }

    function normalizePayload(raw) {
      if (!raw) return "";
      const s = String(raw).trim();
      try { return decodeURIComponent(s); } catch { return s; }
    }

    async function verifyPayload(payload) {
      const tok = getToken();
      if (!tok) {
        setStatus(resultBox, "Locked. Enter admin password first.", "bad");
        return;
      }

      const normalized = normalizePayload(payload);
      if (!normalized) {
        setStatus(resultBox, "No payload to verify.", "bad");
        return;
      }

      // ✅ Debounce duplicate scans within 2.5s
      const now = Date.now();
      if (normalized === lastPayload && (now - lastPayloadAt) < 2500) {
        return;
      }
      lastPayload = normalized;
      lastPayloadAt = now;

      if (verifyInFlight) return;
      verifyInFlight = true;

      setStatus(resultBox, "Verifying…", "");

      try {
        const res = await fetch("/.netlify/functions/verifyPickupQr", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "Authorization": `Bearer ${tok}`
          },
          body: JSON.stringify({ payload: normalized })
        });

        const text = await res.text();
        let parsed;
        try { parsed = JSON.parse(text); } catch { parsed = { raw: text }; }

        if (!res.ok) {
          const msg = parsed?.error || parsed?.message || `${res.status} ${res.statusText}`;
          setStatus(resultBox, `❌ ${msg}\n${JSON.stringify(parsed, null, 2)}`, "bad");
          return;
        }

        setStatus(resultBox, `✅ SUCCESS\n${JSON.stringify(parsed, null, 2)}`, "ok");
      } catch (e) {
        setStatus(resultBox, `❌ Network/Error: ${e.message}`, "bad");
      } finally {
        // ✅ allow next scan after a moment
        setTimeout(() => { verifyInFlight = false; }, 1200);
      }
    }

    async function startCamera() {
      const tok = getToken();
      if (!tok) {
        setStatus(resultBox, "Locked. Enter admin password first.", "bad");
        return;
      }
      if (scanning) return;

      if (!html5QrCode) html5QrCode = new Html5Qrcode(readerId);

      setStatus(resultBox, "Starting camera…", "");
      scanning = true;

      try {
        const cams = await Html5Qrcode.getCameras();
        const camId = cams?.[0]?.id;
        if (!camId) throw new Error("No camera found");

        await html5QrCode.start(
          camId,
          { fps: 10, qrbox: { width: 280, height: 280 } },
          async (decodedText) => {
            if (verifyInFlight) return; // ✅ don’t spam requests
            payloadEl.value = normalizePayload(decodedText);
            // Auto-verify immediately on scan:
            await verifyPayload(payloadEl.value);
          },
          () => {}
        );

        setStatus(resultBox, "Camera running. Scan a QR code…", "ok");
      } catch (e) {
        scanning = false;
        setStatus(resultBox, `❌ Camera start failed: ${e.message}`, "bad");
      }
    }

    async function stopCamera() {
      if (!html5QrCode || !scanning) return;
      try { await html5QrCode.stop(); } catch {}
      scanning = false;
      setStatus(resultBox, "Stopped.", "");
    }

    // Buttons
    document.getElementById("unlockBtn").addEventListener("click", () => {
      const t = adminTokenEl.value.trim();
      if (!t) return;
      setToken(t);
      adminTokenEl.value = "";
      setStatus(resultBox, "Unlocked. Click Start Camera or paste a payload and Verify.", "ok");
    });

    document.getElementById("lockBtn").addEventListener("click", async () => {
      await stopCamera();
      setToken("");
      setStatus(resultBox, "Locked.", "");
    });

    document.getElementById("verifyBtn").addEventListener("click", () => {
      verifyPayload(payloadEl.value);
    });

    document.getElementById("startBtn").addEventListener("click", startCamera);
    document.getElementById("stopBtn").addEventListener("click", stopCamera);

    // Init
    refreshAuth();
  </script>
</body>
</html>
